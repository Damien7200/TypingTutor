
{%extends "Typing/base.html"%}
{%block content%}
<header>
    <a href = "{% url 'Typing:settings'%}">settings</a>
</header>

<div class = "typing-box-container">
    <textarea class = "typing-box" cols = '100' id= "typing-box" colomns wrap = 'hard' spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>




    <div class = "TText" id= "TText">
            
            
            
        
        {% comment %} Text to type {% endcomment %}
    </div>
</div>






<div id = 'help-bar'>

    <p>press Tab to restart</p>

</div>

<div id = 'difficulty-container' class="difficulty-container" >
    <label for ="difficulty-select">Difficulty</label>
    <select id="difficulty-select" name="difficulty">
        <option value="easy" selected>Easy</option>
        <option value="medium">Medium</option>
        <option value="hard">Hard</option>
    </select>
</div>
<div class="topic-container" >
    <label for = "topic-select">Word Topic</label>
    <select id="topic-select" name="topic">
        <option value = "General" selected>General Terminology</option>
        <option value="PF" >Programming fundamentals</option>
        <option value="OOP">Object-oriented programming</option>
        <option value="PM">Programming mechatronics</option>
        <option value="SSA" >Secure software architecture</option>
        <option value="PFTW">Programming for the web</option>
        <option value="SA">Software automation</option>
    </select>
</div>


<div id = 'results-container'></div>
<script>

document.addEventListener('DOMContentLoaded', function() {
const difficultySelect = document.getElementById('difficulty-select');
const Typing_box = document.getElementById('typing-box')
const wpm = "wpm placeholder"
const TopicSelector = document.getElementById("topic-select");

Typing_box.addEventListener('keydown', function(event) {
  if (event.key === 'Enter') {
    event.preventDefault();
  }
 
  if (event.key == 'Tab'){
    const inputBox = document.getElementById("typing-box")
    inputBox.value = '';
  }


});


Typing_box.addEventListener('input', function(){
    const CurrentLength = Typing_box.value.length;
    const WordLength = words.length;
    if (CurrentLength == WordLength){
        //render the results template
        console.log('sufficient characters typed');
        Results()
    }

});
function getCookie(name) {
    const cookie = document.cookie.split(';').find(c => c.trim().startsWith(name + '='));
    return cookie ? decodeURIComponent(cookie.split('=')[1]) : null;
    }
function updateWordBank(difficulty) {
    console.log("Fetching words for:", difficulty);
    //sending request to view update_word_bank which tehn updates the partial template, and then sends a response witht the partial template, letting it be rendered. 
    fetch("{% url 'Typing:update_word_bank' %}", {
        method: "POST",
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ difficulty: difficulty })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('TText').innerHTML = data.html;
        words = data.words
    
        
    });
    }

/*
difficultySelect.addEventListener('change', event => {
    const CurrentValue = event.target.value
    updateWordBank(CurrentValue);
});
updateWordBank(difficultySelect.value) // pass the value from the determinator into here. 
*/

function determinator(){
    //needs to return a difficulty value of whatever the user has chosen. general is hard
    
    const Dcontainer = document.getElementById('difficulty-container');
    if (TopicSelector.value == 'General'){
        console.log("general")
        updateWordBank(difficultySelect.value)
        Dcontainer.style.display = 'inline'
       

            
 

    }else{
        console.log('not genral')
        Dcontainer.style.display = 'none'
        updateWordBank(TopicSelector.value)
    }


};
determinator()
TopicSelector.addEventListener('change', determinator)

difficultySelect.addEventListener('change', function(event) {
    if (TopicSelector.value == 'General'){
        updateWordBank(event.target.value)
    }


 });
            

function Results(){
    const Results_container = document.getElementById('results-container')
    const inputBox = document.getElementById("typing-box")

    fetch ("{%url 'Typing:Results'%}",{
        method: "POST",
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body:JSON.stringify({wpm : wpm})
    })
    .then(response => response.json())
    .then(data=>{
        Results_container.innerHTML = data.html;
        Results_container.style.display = 'block';
        console.log('template rendered')
        inputBox.blur()

    });

    const spaceHandler = function(event) {
        if (event.key === "Enter") {
            Results_container.style.display = 'none';
            inputBox.value = '';
            document.removeEventListener("keydown", spaceHandler); // Remove listener
        }
    };
    document.addEventListener("keydown", spaceHandler);
};

});
</script>



{% endblock %}